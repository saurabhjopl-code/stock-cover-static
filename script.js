// script.js implementing requested logic
function $(id){ return document.getElementById(id); }
const salesFileInput=$('salesFile'), stockFileInput=$('stockFile'), sellerFileInput=$('sellerFile'), mappingFileInput=$('mappingFile'); const processBtn=$('processBtn'), resetBtn=$('resetBtn'), statusDiv=$('status'), resultsSection=$('results'), summaryCardsDiv=$('summaryCards'), tableContainer=$('tableContainer'), templatesBtn=$('downloadTemplates'), warehouseSelect=$('warehouseFilter'), clearWarehouseBtn=$('clearWarehouse'), downloadSummaryBtn=$('downloadSummary'), downloadWarehouseBtn=$('downloadWarehouse'), downloadRefillBtn=$('downloadRefill'), downloadExcessBtn=$('downloadExcess'), downloadUnmappedBtn=$('downloadUnmapped'), thresholdInput=$('threshold'); let cached={summary:null,warehouse:null,refill:null,excess:null,unmapped:[]}; let selectedWarehouses=new Set(); processBtn.addEventListener('click',handleProcess); resetBtn.addEventListener('click',handleReset); templatesBtn.addEventListener('click',downloadTemplates); warehouseSelect.addEventListener('change',onWarehouseChange); clearWarehouseBtn.addEventListener('click',clearWarehouse); downloadSummaryBtn.addEventListener('click',()=>downloadCSV(cached.summary,'stock_cover_summary_45d.csv')); downloadWarehouseBtn.addEventListener('click',()=>downloadCSV(cached.warehouse,'warehouse_level_stock_45d.csv')); downloadRefillBtn.addEventListener('click',()=>downloadCSV(cached.refill,'refill_recommendations_45d.csv')); downloadExcessBtn.addEventListener('click',()=>downloadCSV(cached.excess,'excess_stock_over_60d.csv')); downloadUnmappedBtn.addEventListener('click',()=>downloadCSV(cached.unmapped,'unmapped_flipkart_skus.csv')); document.querySelectorAll('.tab').forEach(btn=>btn.addEventListener('click',(e)=>{document.querySelectorAll('.tab').forEach(b=>b.classList.remove('active')); btn.classList.add('active'); renderCurrentTab(); } )); function status(msg,err=false){ statusDiv.textContent=msg; statusDiv.style.color=err? '#b91c1c' : ''; } function handleReset(){ salesFileInput.value=''; stockFileInput.value=''; sellerFileInput.value=''; mappingFileInput.value=''; cached={summary:null,warehouse:null,refill:null,excess:null,unmapped:[]}; selectedWarehouses.clear(); warehouseSelect.innerHTML=''; summaryCardsDiv.classList.add('hidden'); resultsSection.classList.add('hidden'); tableContainer.innerHTML=''; status('Reset complete'); } async function handleProcess(){ status('Validating files...'); const sf=salesFileInput.files[0], stf=stockFileInput.files[0], sellerf=sellerFileInput.files[0], mapf=mappingFileInput.files[0]; if(!sf||!stf||!sellerf){ status('Please upload Sales, FBF stock and Seller stock CSVs.', true); return; } const threshold=Number(thresholdInput.value)||5; try{ status('Parsing CSVs...'); const [sales,fbf,seller,mapping]=await Promise.all([parseCSV(sf),parseCSV(stf),parseCSV(sellerf), mapf?parseCSV(mapf):Promise.resolve([])]); status('Processing data...'); const mapFlipToSeller=buildMapping(mapping); const sellerTotals=pivotSellerStock(seller); const salesNormalized=normalizeSales(sales); const fbfNormalized=normalizeFBFStock(fbf); const dateInfo=computeDateRange(salesNormalized); const days_in_period=dateInfo.days; const date_min=dateInfo.minStr; const date_max=dateInfo.maxStr; const drrMap=computeDRR(salesNormalized,days_in_period); const warehouseRows=aggregateFBF(fbfNormalized); const summary=buildSummary(drrMap,warehouseRows,mapFlipToSeller,sellerTotals,threshold,days_in_period,date_min,date_max); const warehouseWithDRR=warehouseRows.map(w=>{const d=drrMap[w.SKU]||{DRR:0,requirement45:0,totalSales:0}; const cover=d.DRR===0?Infinity:Number((w['FBF Stock']/d.DRR).toFixed(2)); return {'Flipkart SKU':w.SKU,'Unique SKU':mapFlipToSeller[w.SKU]||'','Warehouse Id':w['Warehouse Id'],'FBF Stock':w['FBF Stock'],'DRR':Number((d.DRR||0).toFixed(2)),'45day_requirement':Number((d.requirement45||0).toFixed(2)),'Stock Cover Days (Warehouse)':cover}; }); const refill=summary.map(s=>({'Flipkart SKU':s['Flipkart SKU'],'Unique SKU':s['Unique SKU']||'','Required Qty to reach 45d':s['Required Qty to reach 45d'],'Total FBF Stock':s['Total FBF Stock'],'Seller Stock':s['Seller Stock']||0,'AllocateToFBF':s['AllocateToFBF'],'AllocationReason':s['AllocationReason'],'Recommended Warehouse':s['Recommended Warehouse']})).filter(r=>(r['Required Qty to reach 45d']||0)>0); const excess=warehouseWithDRR.map(w=>{const cover=w['Stock Cover Days (Warehouse)']; const dr=Number(w.DRR)||0; const live=Number(w['FBF Stock'])||0; const excessQty=(dr&&cover>60)?Math.max(0,Math.round(live-dr*60)):0; return {'Flipkart SKU':w['Flipkart SKU'],'Unique SKU':w['Unique SKU']||'','Warehouse Id':w['Warehouse Id'],'FBF Stock':w['FBF Stock'],'DRR':w.DRR,'Stock Cover Days (Warehouse)':w['Stock Cover Days (Warehouse)'],'Excess Qty (if >60 days)':excessQty}; }).filter(e=>e['Excess Qty (if >60 days)']>0); const unmapped=summary.filter(s=>!s['Unique SKU']).map(s=>({'Flipkart SKU':s['Flipkart SKU']})); summary.sort((a,b)=>String(a['Flipkart SKU']).localeCompare(String(b['Flipkart SKU']))); warehouseWithDRR.sort((a,b)=>String(a['Flipkart SKU']).localeCompare(String(b['Flipkart SKU']))); refill.sort((a,b)=>String(a['Flipkart SKU']).localeCompare(String(b['Flipkart SKU']))); excess.sort((a,b)=>String(a['Flipkart SKU']).localeCompare(String(b['Flipkart SKU']))); cached.summary=summary; cached.warehouse=warehouseWithDRR; cached.refill=refill; cached.excess=excess; cached.unmapped=unmapped; populateWarehouseFilter(warehouseWithDRR); renderSummaryCards(summary,warehouseWithDRR,refill,excess,date_min,date_max,days_in_period); resultsSection.classList.remove('hidden'); renderCurrentTab(); status('Processing complete. Download CSVs below.'); }catch(err){ console.error(err); status('Error: '+(err&&err.message), true); } } function parseCSV(file){return new Promise((resolve,reject)=>{Papa.parse(file,{header:true,skipEmptyLines:true,complete:(res)=>resolve(res.data),error:(err)=>reject(err)});});} function buildMapping(mapRows){const map={}; if(!mapRows||mapRows.length===0) return map; const keys=Object.keys(mapRows[0]||{}); const low=keys.map(k=>k.toLowerCase().replace(/\s+/g,'')); const flipIdx=low.indexOf('flipkartsku'); const sellerIdx= low.indexOf('sellersku')>=0?low.indexOf('sellersku'):(low.indexOf('uniquesku')>=0?low.indexOf('uniquesku'): (low.indexOf('sellersku')>=0?low.indexOf('sellersku'):1)); const flipKey= flipIdx>=0?keys[flipIdx]: (keys.includes('Flipkart SKU')? 'Flipkart SKU' : keys[0]); const sellerKey= sellerIdx>=0?keys[sellerIdx]: (keys.includes('Seller SKU')? 'Seller SKU': (keys.includes('Unique SKU')? 'Unique SKU': keys[1]||keys[0])); for (let r of mapRows){ const fk=(r[flipKey]||'').toString().trim(); const sk=(r[sellerKey]||'').toString().trim(); if(fk) map[fk]=sk; } return map; } function pivotSellerStock(rows){const map={}; if(!rows) return map; const keys=Object.keys(rows[0]||{}); const low=keys.map(k=>k.toLowerCase().replace(/\s+/g,'')); const sellerKey = keys[ low.indexOf('sellersku')>=0 ? low.indexOf('sellersku') : (low.indexOf('uniquesku')>=0? low.indexOf('uniquesku'):0) ]; const stockKey = keys[ low.indexOf('stock')>=0 ? low.indexOf('stock') : (low.indexOf('sellerstock')>=0? low.indexOf('sellerstock'):1) ]; for (let r of rows){ const sk=(r[sellerKey]||r[sellerKey]===0)?String(r[sellerKey]).trim():''; const qty=Number(String(r[stockKey]||'').replace(/[^0-9.\-eE]/g,''))||0; if(!sk) continue; map[sk]=(map[sk]||0)+qty; } return map; } function normalizeSales(rows){ if(!rows) return []; return rows.map(r=>{ const out={}; const keys=Object.keys(r||{}); for(let k of keys){ const kn=k.toLowerCase().replace(/\s+/g,''); if(kn.includes('flipkartsku')|| kn.includes('sku')) out['Flipkart SKU']=(r[k]||'').toString().trim(); if(kn==='orderdate' || kn==='order_date' || kn==='date') out['Order Date']=(r[k]||'').toString().trim(); if(kn.includes('gross')|| kn.includes('grossunits')|| kn==='grossunits' || kn==='units' || kn==='qty' || kn==='quantity') out['Gross Units']=Number(String(r[k]||'').replace(/[^0-9.\-eE]/g,''))||0; if(kn.includes('fulfillment')) out['Fulfillment Type']=(r[k]||'').toString().trim(); if(kn.includes('location')|| kn.includes('warehouse')) out['Location Id']=(r[k]||'').toString().trim(); } if(!('Gross Units' in out)) out['Gross Units']=1; if(!('Flipkart SKU' in out)){ const first=Object.keys(r||{})[0]; out['Flipkart SKU']=(r[first]||'').toString().trim(); } return out; }).filter(r=>r['Flipkart SKU']); } function normalizeFBFStock(rows){ if(!rows) return []; return rows.map(r=>{ const out={}; const keys=Object.keys(r||{}); for(let k of keys){ const kn=k.toLowerCase().replace(/\s+/g,''); if(kn.includes('warehouse')|| kn.includes('location')) out['Warehouse Id']=(r[k]||'').toString().trim(); if(kn.includes('flipkartsku')|| kn.includes('sku')) out['Flipkart SKU']=(r[k]||'').toString().trim(); if(kn.includes('stock')|| kn.includes('live')) out['FBF Stock']=Number(String(r[k]||'').replace(/[^0-9.\-eE]/g,''))||0; } if(!out['Flipkart SKU']) out['Flipkart SKU']=''; if(!out['Warehouse Id']) out['Warehouse Id']='UNKNOWN'; if(!('FBF Stock' in out)) out['FBF Stock']=0; return out; }); } function parseDateDDMMYYYY(s){ if(!s) return null; s=s.toString().trim(); const m=s.match(/^(\d{2})-(\d{2})-(\d{4})$/); if(m){ const dd=Number(m[1]), mm=Number(m[2]), yyyy=Number(m[3]); if(dd>=1 && dd<=31 && mm>=1 && mm<=12) return new Date(yyyy,mm-1,dd); } const m2=s.match(/^(\d{4})-(\d{2})-(\d{2})$/); if(m2) return new Date(Number(m2[1]),Number(m2[2])-1,Number(m2[3])); const m3=s.match(/^(\d{2})\/(\d{2})\/(\d{4})$/); if(m3) return new Date(Number(m3[3]),Number(m3[1])-1,Number(m3[2])); const m4=s.match(/^(\d{2})\/(\d{2})\/(\d{4})$/); if(m4) return new Date(Number(m4[3]),Number(m4[2])-1,Number(m4[1])); const d=new Date(s); if(!isNaN(d)) return d; return null; } function computeDateRange(salesRows){ const dates=[]; for(let r of salesRows){ const d=parseDateDDMMYYYY(r['Order Date']); if(d) dates.push(d); } if(dates.length===0){ const today=new Date(); const min=new Date(today); min.setDate(min.getDate()-29); const max=today; return {minDate:min,maxDate:max,days:30,minStr:formatDate(min),maxStr:formatDate(max)} } const minD=new Date(Math.min(...dates.map(d=>d.getTime()))); const maxD=new Date(Math.max(...dates.map(d=>d.getTime()))); const diff=Math.round((maxD-minD)/(1000*60*60*24)); const days=diff+1; return {minDate:minD,maxDate:maxD,days:days,minStr:formatDate(minD),maxStr:formatDate(maxD)} } function formatDate(d){ if(!d) return ''; const dd=String(d.getDate()).padStart(2,'0'); const mm=String(d.getMonth()+1).padStart(2,'0'); const yyyy=d.getFullYear(); return dd+'-'+mm+'-'+yyyy; } function computeDRR(salesRows,days){ const map={}; for(let r of salesRows){ const sku=r['Flipkart SKU']; const qty=Number(r['Gross Units'])||0; if(!sku) continue; map[sku]=map[sku]||{totalSales:0}; map[sku].totalSales+=qty; } for(let sku in map){ const total=map[sku].totalSales||0; const drr=days>0? (total/days):0; map[sku].DRR=drr; map[sku].requirement45=drr*45; } return map; } function aggregateFBF(fbfRows){ const group={}; for(let r of fbfRows){ const sku=r['Flipkart SKU']; const wh=r['Warehouse Id']||'UNKNOWN'; const live=Number(r['FBF Stock'])||0; const key=sku+'||'+wh; group[key]=(group[key]||0)+live; } const rows=[]; for(let k of Object.keys(group)){ const [sku,wh]=k.split('||'); rows.push({SKU:sku,'Warehouse Id':wh,'FBF Stock':group[k]}); } return rows; } function buildSummary(drrMap,warehouseRows,mapping,sellerTotals,threshold,days,date_min,date_max){ const totalBySku={}; for(let w of warehouseRows) totalBySku[w.SKU]=(totalBySku[w.SKU]||0)+(Number(w['FBF Stock'])||0); const summary=[]; for(let sku in drrMap){ const d=drrMap[sku]; const totalFbf=totalBySku[sku]||0; const cover=d.DRR===0?Infinity:Number((totalFbf/d.DRR).toFixed(2)); const req45=Math.max(0,Math.ceil((d.requirement45||0)-totalFbf)); const unique=mapping[sku]||''; const sellerStock=unique? (sellerTotals[unique]||0):0; const postBalance=sellerStock-req45; let allocate=false; let reason=''; if(!unique){ allocate=false; reason='No mapping (cannot use seller stock)'; } else if(req45<=0){ allocate=false; reason='No refill required'; } else if(sellerStock<=0){ allocate=false; reason='Seller stock unknown or zero'; } else if(postBalance<threshold){ allocate=false; reason='Seller stock insufficient (post-allocation < threshold)'; } else { allocate=true; reason='Sufficient seller stock'; } const candidateWh=warehouseRows.filter(w=>w.SKU===sku).sort((a,b)=> (b['FBF Stock']||0)-(a['FBF Stock']||0))[0]; const recommended=candidateWh?candidateWh['Warehouse Id']:''; summary.push({'Flipkart SKU':sku,'Unique SKU':unique,'date_min':date_min,'date_max':date_max,'Days_in_period':days,'Total Sales':d.totalSales||0,'DRR':Number((d.DRR||0).toFixed(2)),'45day_requirement':Number((d.requirement45||0).toFixed(2)),'Total FBF Stock':totalFbf,'Stock Cover Days (SKU level)':cover,'Needs Refill (45d)':req45>0?'Yes':'No','Required Qty to reach 45d':req45,'Seller Stock':sellerStock,'AllocateToFBF':allocate?'Yes':'No','AllocationReason':reason,'Recommended Warehouse':allocate?recommended:''}); } const skusInFBF=Array.from(new Set(warehouseRows.map(w=>w.SKU))); for(let sku of skusInFBF){ if(drrMap[sku]) continue; const totalFbf=totalBySku[sku]||0; const unique=mapping[sku]||''; const sellerStock=unique?(sellerTotals[unique]||0):0; summary.push({'Flipkart SKU':sku,'Unique SKU':unique,'date_min':date_min,'date_max':date_max,'Days_in_period':days,'Total Sales':0,'DRR':0,'45day_requirement':0,'Total FBF Stock':totalFbf,'Stock Cover Days (SKU level)':Infinity,'Needs Refill (45d)':'No','Required Qty to reach 45d':0,'Seller Stock':sellerStock,'AllocateToFBF':'No','AllocationReason':'No sales (DRR=0)','Recommended Warehouse':''}); } return summary; } function formatNum(v){ if(v===Infinity) return '∞'; if(v===null||v===undefined||v==='') return '-'; if(Number.isInteger(v)) return v.toString(); const n=Number(v); return isNaN(n)?String(v):n.toFixed(2); } function renderSummaryCards(summary,warehouse,refill,excess,date_min,date_max,days){ summaryCardsDiv.innerHTML=''; summaryCardsDiv.classList.remove('hidden'); const div=document.createElement('div'); div.className='cards'; const cards=[{title:'SKUs (summary)',value:summary.length},{title:'Warehouse rows',value:warehouse.length},{title:'SKUs needing refill',value:refill.length},{title:'Excess entries (>60d)',value:excess.length}]; for(let c of cards){ const card=document.createElement('div'); card.className='card'; card.innerHTML=`<div class="title">${c.title}</div><div class="value">${c.value}</div>`; div.appendChild(card);} summaryCardsDiv.appendChild(div); const info=document.createElement('div'); info.className='small-muted'; info.style.marginTop='8px'; info.textContent=`Date range: ${date_min} → ${date_max} (${days} days)`; summaryCardsDiv.appendChild(info);} function populateWarehouseFilter(warehouseRows){ const set=new Set(warehouseRows.map(r=>r['Warehouse Id']).filter(Boolean)); const arr=Array.from(set).sort((a,b)=>String(a).localeCompare(String(b))); warehouseSelect.innerHTML=''; for(let w of arr){ const opt=document.createElement('option'); opt.value=w; opt.textContent=w; warehouseSelect.appendChild(opt);} } function onWarehouseChange(){ selectedWarehouses.clear(); for(let opt of warehouseSelect.selectedOptions) selectedWarehouses.add(opt.value); renderCurrentTab(); } function clearWarehouse(){ warehouseSelect.selectedIndex=-1; selectedWarehouses.clear(); renderCurrentTab(); } function renderCurrentTab(){ const tab=document.querySelector('.tab.active').getAttribute('data-tab'); renderTable(tab); } function renderTable(tab){ tableContainer.innerHTML=''; let rows=[], cols=[]; if(tab==='summary'){ rows=cached.summary||[]; cols=['Flipkart SKU','Unique SKU','Total Sales','date_min','date_max','Days_in_period','DRR','45day_requirement','Total FBF Stock','Stock Cover Days (SKU level)','Needs Refill (45d)','Required Qty to reach 45d','Seller Stock','AllocateToFBF','AllocationReason','Recommended Warehouse']; } else if(tab==='warehouse'){ rows=cached.warehouse||[]; cols=['Flipkart SKU','Unique SKU','Warehouse Id','FBF Stock','DRR','45day_requirement','Stock Cover Days (Warehouse)']; } else if(tab==='refill'){ rows=cached.refill||[]; cols=['Flipkart SKU','Unique SKU','Required Qty to reach 45d','Total FBF Stock','Seller Stock','AllocateToFBF','AllocationReason','Recommended Warehouse']; } else if(tab==='excess'){ rows=cached.excess||[]; cols=['Flipkart SKU','Unique SKU','Warehouse Id','FBF Stock','DRR','Stock Cover Days (Warehouse)','Excess Qty (if >60 days)']; } if(selectedWarehouses.size>0 && (tab==='warehouse'||tab==='refill'||tab==='excess')) rows=rows.filter(r=> r['Warehouse Id']? selectedWarehouses.has(r['Warehouse Id']): false); const table=document.createElement('table'); const thead=document.createElement('thead'); const thr=document.createElement('tr'); for(let c of cols){ const th=document.createElement('th'); th.textContent=c; thr.appendChild(th);} thead.appendChild(thr); table.appendChild(thead); const tbody=document.createElement('tbody'); for(let r of rows){ const tr=document.createElement('tr'); for(let c of cols){ const td=document.createElement('td'); const v=r[c]!==undefined? r[c] : (r[c.toLowerCase()]!==undefined? r[c.toLowerCase()]: ''); td.textContent=formatNum(v); tr.appendChild(td);} tbody.appendChild(tr);} table.appendChild(tbody); tableContainer.appendChild(table);} function downloadCSV(dataArr,filename){ if(!dataArr||dataArr.length===0){ alert('No data to download'); return; } const cols=Object.keys(dataArr[0]); const lines=[cols.join(',')].concat(dataArr.map(r=> cols.map(c=>{ const v=r[c]===undefined?'':String(r[c]); return `"${v.replace(/"/g,'""')}"`; }).join(','))); const blob=new Blob([lines.join('\n')],{type:'text/csv'}); const url=URL.createObjectURL(blob); const a=document.createElement('a'); a.href=url; a.download=filename; a.click(); URL.revokeObjectURL(url);} function downloadTemplates(){ const templates={'template_flipkart_sales.csv':'Flipkart SKU,Order Date,Fulfillment Type,Location Id,Gross Units\nJOPLST218,01-11-2025,FBF,ulub_bts,2\n','template_fbf_stock.csv':'Warehouse Id,Flipkart SKU,Stock\nulub_bts,JOPLST218,10\n','template_seller_stock.csv':'Seller SKU,Stock\nJOPL-001,50\n','template_mapping.csv':'Seller SKU,Flipkart SKU\nJOPL-001,JOPLST218\n'}; for(let name in templates){ const blob=new Blob([templates[name]],{type:'text/csv'}); const url=URL.createObjectURL(blob); const a=document.createElement('a'); a.href=url; a.download=name; a.click(); URL.revokeObjectURL(url);} }